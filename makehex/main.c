#include <stdio.h>
#include <ctype.h>
#include <string.h>

char lookup[128] =
{
	0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0, // 00
	0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0, // 10
	0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0, // 20
	0x0,0x1,0x2,0x3,0x4,0x5,0x6,0x7,0x8,0x9,0x0,0x0,0x0,0x0,0x0,0x0, // 30
	0x0,0xA,0xB,0xC,0xD,0xE,0xF,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0, // 40
	0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0, // 50
	0x0,0xA,0xB,0xC,0xD,0xE,0xF,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0, // 60
	0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0  // 70
};

int main (int argc, char* argv[])
{
	FILE* in, *out;
	int width = 4;
	int reverse = 0;
	char buffer[512];
	++argv, --argc;
	while (*argv && **argv == '-')
	{
		switch((*argv)[1])
		{
		case 'r': reverse = 1; break;
		case 'b': width = 1; break;
		}
		++argv, --argc;
	}
	if (argc < 2)
	{
		printf ("usage: %s [-rb] inhex outbin\n",argv[0]);
		return -1;
	}
	if (reverse)
	{
		int readcnt;
		in = fopen(argv[0],"rb");
		out = fopen(argv[1],"w");
		while ((readcnt = fread(buffer,sizeof(char),512,in)) > 0)
		{
			int i;
			for (i = 0; i < readcnt; ++i)
			{
				if (width == 1)
				{
					int j;
					unsigned char v = (unsigned char)buffer[i];
					for (j = 7; j >= 0; --j)
						fputc(v&(1<<j) ? '1' : '0',out);
					fputc(i&1 ? '\n' : ' ',out);
				}
				else
					fprintf(out,"%02X%c",(unsigned char)buffer[i],i % 0x10 == 0xF ? '\n' : ' ');
			}
		}
	}
	else
	{
		unsigned char data = 0;
		int shift = 8-width;
		in = fopen(argv[0],"r");
		out = fopen(argv[1],"wb");
		while (fgets(buffer,512,in))
		{
			char* ptr;
			for (ptr = buffer; *ptr && *ptr != '\n'; ++ptr)
			{
				if (isspace(*ptr)) continue;
				data |= ((*ptr > 0) ? lookup[*ptr] : '\0') << shift;
				if ((shift -= width) < 0)
				{
					fwrite(&data,sizeof(data),1,out);
					shift = 8-width;
					data = 0;
				}
			}
		}
	}
	fclose(out);
	fclose(in);
	return 0;
}